name: CI on Specific Label

on:
  issues:
    types: [labeled]

jobs:
  developer:
    runs-on: [developer]

    if: github.event.issue.state == 'open' && github.event.issue.locked == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Init & dev Plandex
        run: |
          plandex new -n "feat-50"
          plandex models custom -f /actions-runner/config/anthropic-models.json --save
          plandex set-model anthropic-blend
          echo "${{ steps.parse_issue.outputs.prompt }}" | \
            plandex tell --apply --auto-exec --commit --no-exec -

      - name: Push branche vers GitHub
        run: git push --set-upstream origin "${{ steps.parse_issue.outputs.issue_id }}"

      - name: Créer Pull Request
        run: |
          gh pr create \
            --base main \
            --head "${{ steps.parse_issue.outputs.issue_id }}" \
            --title "Merge ${{ steps.parse_issue.outputs.issue_id }} into main" \
            --body "PR auto - ${{ steps.parse_issue.outputs.issue_name }}"

      - name: Merge Pull Request et supprimer branche
        run: gh pr merge "${{ steps.parse_issue.outputs.issue_id }}" --merge --delete-branch

      - name: Fermer l’issue
        run: gh issue close "$ISSUE_NUMBER" --comment "✅ Dev terminé et mergé par Plandex (local, no-cloud)"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
